<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Планировщик кампаний</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f8fb;
      --panel: #0f141a;
      --panel-accent: #1b2430;
      --card: #fff;
      --grid-dot: #dfe6f0;
      --green: #2c9a57;
      --green-2: #3abf73;
      --purple: #6a4de3;
      --blue: #5da8ff;
      --gray: #7b8a9c;
      --border: #e2e7ef;
      --shadow: 0 6px 18px rgba(17, 24, 39, 0.08);
      --radius: 16px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      background: var(--bg);
      font-family: "Manrope", "Segoe UI", system-ui, -apple-system, sans-serif;
      color: #1b2027;
    }

    button {
      font: inherit;
      border: none;
      background: none;
      cursor: pointer;
    }

    .panel-shell {
      display: grid;
      grid-template-columns: 80px 1fr;
      height: 100vh;
      overflow: hidden;
    }

    .nav {
      background: var(--panel);
      color: #dbe3f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 0;
      gap: 12px;
      border-right: 1px solid rgba(255,255,255,0.04);
    }

    .nav .logo {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      background: linear-gradient(145deg, #28ae66, #1d8c50);
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.5px;
      box-shadow: 0 8px 18px rgba(28, 190, 100, 0.3);
    }

    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 100%;
      align-items: center;
      margin-top: 8px;
    }

    .nav-btn {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      color: #d8e0eb;
      transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease;
    }

    .nav-btn:hover {
      background: var(--panel-accent);
      transform: translateY(-1px);
    }

    .nav-btn.active {
      background: var(--panel-accent);
      color: #6cdba0;
    }

    .nav .spacer {
      flex: 1 1 auto;
    }

    .workspace {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .topbar {
      background: #fff;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px rgba(15, 23, 42, 0.04);
    }

    .top-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .back-btn {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: var(--bg);
      display: grid;
      place-items: center;
      color: #1f2933;
      border: 1px solid var(--border);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .title-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .page-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border: 1px solid #dce4ee;
      color: #4b5563;
    }

    .pill.success { background: #e7f7ee; border-color: #c2ead4; color: #2c9a57; }
    .pill.progress { background: #e8e9ff; border-color: #d3d6ff; color: #5a57d7; }

    .time-stamp {
      font-size: 13px;
      color: #6b7280;
    }

    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 600;
      border: 1px solid var(--border);
      background: #fff;
      color: #1f2933;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.1s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    .btn:hover { box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08); transform: translateY(-1px); }
    .btn.primary { background: var(--green-2); border-color: #2c9a57; color: #fff; }
    .btn.ghost { background: #f4f6fb; }
    .btn.square { width: 40px; height: 40px; padding: 0; justify-content: center; }

    .toolbar {
      background: #fff;
      border-bottom: 1px solid var(--border);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      overflow-x: auto;
      scrollbar-width: thin;
    }

    .tool {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f4f6fb;
      color: #1f2933;
      border: 1px solid transparent;
      font-weight: 600;
      white-space: nowrap;
    }

    .tool:hover { border-color: #dde3ef; background: #eef1fb; }

    .tool.active { background: #e9f6ed; color: var(--green); border-color: #bfe7cc; }

    .board-wrapper {
      position: relative;
      display: grid;
      grid-template-columns: 1fr 360px;
      height: calc(100vh - 120px);
    }

    .board {
      position: relative;
      background: radial-gradient(var(--grid-dot) 1px, transparent 1px);
      background-size: 24px 24px;
      overflow: hidden;
      cursor: default;
    }

    .board.connecting {
      cursor: crosshair;
    }

    .board-viewport {
      position: absolute;
      inset: 0;
      transform-origin: 0 0;
    }

    .connections {
      position: absolute;
      inset: 0;
      pointer-events: auto;
      width: 100%;
      height: 100%;
    }

    .connections path:hover {
      stroke: #6a4de3;
      stroke-width: 2.6;
    }

    .node-layer {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .node {
      position: absolute;
      background: var(--card);
      border-radius: 18px;
      min-width: 160px;
      padding: 14px 16px 12px;
      box-shadow: var(--shadow);
      border: 1px solid #e2e7ef;
      display: grid;
      gap: 10px;
    }

    .node-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 700;
      color: #1f2933;
    }

    .node-sub {
      font-size: 13px;
      color: #6b7280;
      line-height: 1.3;
    }

    .node-actions {
      display: flex;
      gap: 6px;
      align-items: center;
      margin-top: -4px;
    }

    .tag {
      padding: 6px 10px;
      border-radius: 10px;
      background: #eef2f7;
      font-size: 12px;
      color: #556274;
      border: 1px solid #e2e7ef;
      font-weight: 600;
      width: fit-content;
    }

    .node-type {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      display: grid;
      place-items: center;
      color: #fff;
      font-weight: 800;
      box-shadow: 0 10px 22px rgba(0,0,0,0.08);
    }

    .type-event { background: linear-gradient(135deg, #31c06b, #1f9a4f); }
    .type-condition { background: linear-gradient(135deg, #5f6fee, #4d55c8); }
    .type-group { background: linear-gradient(135deg, #8b5cf6, #7040d6); }
    .type-wait { background: linear-gradient(135deg, #61b6ff, #3e8bff); }

    .port {
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #d6dde8;
      top: 50%;
      transform: translateY(-50%);
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    .port.in { left: -8px; }
    .port.out { right: -8px; }
    .port.target { border-color: #6a4de3; box-shadow: 0 0 0 4px rgba(106, 77, 227, 0.12); }
    .port.pulse::after {
      content: "";
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid rgba(76, 175, 80, 0.35);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(0.8); opacity: 0.7; }
      70% { transform: scale(1.4); opacity: 0; }
      100% { opacity: 0; }
    }

    .connector-label {
      position: absolute;
      background: #fff;
      padding: 4px 8px;
      border-radius: 10px;
      border: 1px solid #e2e7ef;
      font-size: 12px;
      color: #4b5563;
      box-shadow: var(--shadow);
      transform: translate(-50%, -50%);
      white-space: nowrap;
      pointer-events: none;
    }

    .detail-panel {
      background: #fff;
      border-left: 1px solid var(--border);
      padding: 18px 22px;
      display: grid;
      grid-template-rows: auto 1fr;
      gap: 14px;
      box-shadow: -6px 0 18px rgba(15, 23, 42, 0.04);
    }

    .detail-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .detail-title {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .detail-title h3 {
      margin: 0;
      font-size: 18px;
    }

    .detail-body {
      overflow: auto;
      padding-right: 8px;
      display: grid;
      gap: 16px;
    }

    .field {
      display: grid;
      gap: 6px;
    }

    .label {
      font-weight: 600;
      font-size: 13px;
      color: #4b5563;
    }

    .input, select {
      width: 100%;
      border-radius: 12px;
      border: 1px solid #d9e1ec;
      padding: 12px 12px;
      background: #f8fafc;
      font: inherit;
      color: #1f2933;
    }

    .checkbox-row, .radio-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: #1f2933;
    }

    .divider {
      height: 1px;
      background: #e5e9f0;
      margin: 6px 0;
    }

    .panel-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }

    .outline {
      background: #fff;
      border: 1px solid #dce2ed;
      color: #1f2933;
    }

    .subtle {
      background: #f3f6fa;
      border: 1px solid #e1e6f0;
      color: #556274;
    }

    .legend {
      display: flex;
      gap: 12px;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      background: linear-gradient(90deg, rgba(233, 243, 255, 0.6), rgba(255,255,255,0.9));
    }

    .legend .kbd {
      padding: 6px 8px;
      border-radius: 8px;
      background: #eef1f7;
      border: 1px solid #d9e1ec;
      font-weight: 700;
      color: #4b5563;
    }

    .legend .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #aab3c2;
      display: inline-block;
    }

    .zoom-controls {
      position: absolute;
      right: 12px;
      bottom: 12px;
      background: #fff;
      border: 1px solid #dfe4ee;
      box-shadow: var(--shadow);
      border-radius: 12px;
      display: grid;
      grid-template-columns: repeat(3, 40px);
      overflow: hidden;
    }

    .zoom-btn {
      height: 40px;
      display: grid;
      place-items: center;
      border-right: 1px solid #e5e9f0;
      background: #f8fafc;
      transition: background 0.15s ease;
    }

    .zoom-btn:last-child { border-right: none; }
    .zoom-btn:hover { background: #eef2f8; }

    /* Responsive fallback */
    @media (max-width: 1100px) {
      .board-wrapper { grid-template-columns: 1fr; }
      .detail-panel { display: none; }
      .panel-shell { grid-template-columns: 64px 1fr; }
      .nav-btn { width: 46px; height: 46px; }
      .board { height: calc(100vh - 160px); }
    }
  </style>
</head>
<body>
  <div class="panel-shell">
    <aside class="nav">
      <div class="logo">LP</div>
      <div class="nav-group">
        <button class="nav-btn active" title="Дашборд">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M4 6.5a2 2 0 0 1 2-2h4v6H4z"></path>
            <path d="M4 13.5h6v6H6a2 2 0 0 1-2-2z"></path>
            <path d="M13 4.5h5a2 2 0 0 1 2 2v4h-7z"></path>
            <path d="M13 13.5h7v3a3 3 0 0 1-3 3h-4z"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Поиск">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <circle cx="10.5" cy="10.5" r="5.5"></circle>
            <path d="m15.5 15.5 4 4"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Слои">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M12 3 3 8.5 12 14l9-5.5z"></path>
            <path d="m3 15 9 5 9-5"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Задачи">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <rect x="4" y="4" width="16" height="16" rx="3"></rect>
            <path d="M8 9h8M8 13h5"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Аналитика">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M5 13v6M10 5v14M15 10v10M20 3v17"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Локализация">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M12 3a7 7 0 0 0 0 14 7 7 0 0 0 0-14Z"></path>
            <path d="M3 12h18M12 3c2.5 2.5 2.5 11 0 14M12 3c-2.5 2.5-2.5 11 0 14"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Сценарии">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M4 5h16M6 10h12M4 15h10M8 20h8"></path>
          </svg>
        </button>
      </div>
      <div class="spacer"></div>
      <div class="nav-group">
        <button class="nav-btn" title="Инструменты">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="M3 7h18M3 17h18M9 3v18M15 3v18"></path>
          </svg>
        </button>
        <button class="nav-btn" title="Запуск">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
            <path d="m6 4 12 8-12 8z"></path>
          </svg>
        </button>
      </div>
    </aside>

    <main class="workspace">
      <header class="topbar">
        <div class="top-left">
          <button class="back-btn" aria-label="Назад">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M15 18 9 12l6-6"></path>
            </svg>
          </button>
          <div class="title-block">
            <div class="title-row">
              <span class="page-title">Отток</span>
              <span class="pill success">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M20 6 9 17l-5-5"></path>
                </svg>
                Готов к запуску
              </span>
              <span class="pill progress">15 апреля, 21:49</span>
            </div>
            <div class="time-stamp">Бренд: Test — Сценарий оттока клиентов</div>
          </div>
        </div>
        <div class="top-actions">
          <button class="btn primary">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m7 4 12 8-12 8z"></path>
            </svg>
            Запустить
          </button>
          <button class="btn ghost">Перейти в просмотр</button>
          <button class="btn square">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="9"></circle>
              <path d="M12 7v5l3 3"></path>
            </svg>
          </button>
          <button class="btn square">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="1"></circle>
              <circle cx="5" cy="12" r="1"></circle>
              <circle cx="19" cy="12" r="1"></circle>
            </svg>
          </button>
        </div>
      </header>

      <div class="toolbar">
        <button class="tool active">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#2c9a57" stroke-width="2">
            <path d="M12 2v20M5 9l7-7 7 7"></path>
          </svg>
          Событие
        </button>
        <button class="tool">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#5f6fee" stroke-width="2">
            <path d="M6 6h12v12H6z"></path>
            <path d="M9 9h6v6H9z"></path>
          </svg>
          Условие
        </button>
        <button class="tool">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#8b5cf6" stroke-width="2">
            <path d="M4 8h16v4H4zM8 12h8v4H8z"></path>
          </svg>
          Группа шагов
        </button>
        <button class="tool">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#5da8ff" stroke-width="2">
            <circle cx="12" cy="12" r="8"></circle>
            <path d="M12 7v5l3 2"></path>
          </svg>
          Ожидание
        </button>
        <button class="tool">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#f2994a" stroke-width="2">
            <path d="m5 5 14 14m0-14-14 14"></path>
          </svg>
          Разделение
        </button>
        <button class="tool">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#6b7280" stroke-width="2">
            <path d="M5 12h14M12 5v14"></path>
          </svg>
          Другое
        </button>
      </div>

      <div class="board-wrapper">
        <div class="board" id="board">
          <div class="board-viewport" id="boardViewport">
            <svg class="connections" id="connections"></svg>
            <div class="node-layer" id="nodeLayer"></div>
          </div>
          <div class="zoom-controls">
            <button class="zoom-btn" id="zoomOut" aria-label="Уменьшить">−</button>
            <div class="zoom-btn" id="zoomValue" aria-label="Текущий масштаб">100%</div>
            <button class="zoom-btn" id="zoomIn" aria-label="Увеличить">+</button>
          </div>
        </div>

        <aside class="detail-panel">
          <div class="detail-header">
            <div class="detail-title">
              <div class="node-type type-wait">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                  <circle cx="12" cy="12" r="8"></circle>
                  <path d="M12 7v5l3 2"></path>
                </svg>
              </div>
              <div>
                <h3>Задержка и ожидание события</h3>
                <div class="time-stamp">Добавить описание</div>
              </div>
            </div>
            <button class="btn square outline" aria-label="Закрыть">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="m6 6 12 12M6 18 18 6"></path>
              </svg>
            </button>
          </div>
          <div class="detail-body">
            <div class="radio-row">
              <input type="radio" name="delay" id="fixed">
              <label for="fixed">Фиксированная задержка</label>
            </div>
            <div class="radio-row">
              <input type="radio" name="delay" id="dynamic" checked>
              <label for="dynamic">Динамическая задержка</label>
            </div>
            <div class="field">
              <div class="label">Сработать</div>
              <div style="display:flex; gap:8px;">
                <select><option>Через</option><option>Через после</option></select>
                <input class="input" type="number" value="5" min="0" style="max-width:80px;">
                <select><option>Суток</option><option>Часов</option></select>
              </div>
            </div>
            <div class="field">
              <div class="label">После даты из поля</div>
              <select>
                <option>Клиента</option>
                <option>Заказа</option>
              </select>
            </div>
            <div class="divider"></div>
            <div class="checkbox-row">
              <input type="checkbox" id="limit" checked>
              <label for="limit">Ограничить выход из блока по времени</label>
            </div>
            <div class="field">
              <div class="label">Часовой пояс</div>
              <select>
                <option>(UTC+03:00) Europe/Moscow</option>
                <option>(UTC+01:00) Europe/Berlin</option>
              </select>
            </div>
            <div class="field">
              <div class="label">Разрешенные часы</div>
              <select>
                <option>8:00—21:00</option>
                <option>Круглосуточно</option>
              </select>
            </div>
            <div class="field">
              <div class="label">Разрешенные дни</div>
              <select>
                <option>Рабочие дни недели</option>
                <option>Все дни</option>
              </select>
            </div>
            <div class="divider"></div>
            <div class="checkbox-row">
              <input type="checkbox" id="stop" checked>
              <label for="stop">Прервать ожидание по событию</label>
            </div>
            <div class="field">
              <div class="label">Событие</div>
              <select>
                <option>Розничный заказ добавлен</option>
                <option>Письмо открыто</option>
                <option>Оплата прошла</option>
              </select>
            </div>
            <div class="panel-actions">
              <button class="btn primary" style="flex:1;">Сохранить</button>
              <button class="btn outline">Клонировать</button>
              <button class="btn subtle">Удалить</button>
            </div>
          </div>
        </aside>
      </div>

      <div class="legend">
        <span>Перетаскивай блоки мышью</span>
        <span>Тяни связь: клик по правому порту → отпусти на левом</span>
        <span>Удалить связь: двойной клик по линии</span>
        <span>Масштаб: Ctrl/Cmd + колесо или кнопки +/−</span>
        <span class="dot"></span> Данные сохраняются локально (localStorage)
      </div>
    </main>
  </div>

  <script>
    const board = document.getElementById("board");
    const boardViewport = document.getElementById("boardViewport");
    const nodeLayer = document.getElementById("nodeLayer");
    const connectionsSvg = document.getElementById("connections");
    const zoomOutBtn = document.getElementById("zoomOut");
    const zoomInBtn = document.getElementById("zoomIn");
    const zoomValue = document.getElementById("zoomValue");

    const STORAGE_KEY = "panel_state_v1";
    const defaultState = {
      zoom: 1,
      nodes: [
        { id: "event", type: "event", title: "Событие", subtitle: "Клиент попал в сегмент", x: 140, y: 240 },
        { id: "groupA", type: "group", title: "Группа шагов", subtitle: "Email с рекомендациями", x: 400, y: 240 },
        { id: "condition", type: "condition", title: "Условие", subtitle: "Есть заказ", x: 660, y: 240, badges: ["", ""] },
        { id: "groupB", type: "group", title: "Группа шагов", subtitle: "Исключить из оттока, добавить в активных", x: 930, y: 140 },
        { id: "wait", type: "wait", title: "Ожидание", subtitle: "3 дня", x: 930, y: 320 },
        { id: "groupC", type: "group", title: "Группа шагов", subtitle: "Промокод + повторное письмо", x: 1200, y: 320 }
      ],
      links: [
        { from: "event", to: "groupA" },
        { from: "groupA", to: "condition" },
        { from: "condition", to: "groupB", label: "да" },
        { from: "condition", to: "wait", label: "нет" },
        { from: "wait", to: "groupC" }
      ]
    };

    let state = loadState();
    let zoom = state.zoom || 1;
    let activeConnection = null; // { from, start, path }

    const icons = {
      event: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="7"></circle><path d="M12 8v4l2 2"></path></svg>`,
      condition: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M5 5h14v14H5z"></path><circle cx="9" cy="9" r="1.5"></circle><circle cx="15" cy="15" r="1.5"></circle><path d="M9 9l6 6"></path></svg>`,
      group: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M7 7h10v4H7zM9 13h8v4H9z"></path></svg>`,
      wait: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="8"></circle><path d="M12 7v5l3 2"></path></svg>`
    };

    const typeClass = {
      event: "type-event",
      condition: "type-condition",
      group: "type-group",
      wait: "type-wait"
    };

    function createNodeCard(node) {
      const el = document.createElement("div");
      el.className = "node";
      el.dataset.id = node.id;
      el.style.left = node.x + "px";
      el.style.top = node.y + "px";

      el.innerHTML = `
        <div class="port in"></div>
        <div class="port out pulse"></div>
        <div class="node-header">
          <div class="node-type ${typeClass[node.type]}">${icons[node.type]}</div>
          <div>${node.title}</div>
        </div>
        <div class="node-sub">${node.subtitle}</div>
        ${node.type === "condition" ? '<div class="node-actions"><span class="tag">да</span><span class="tag">нет</span></div>' : ""}
      `;

      return el;
    }

    function renderNodes() {
      nodeLayer.innerHTML = "";
      state.nodes.forEach(node => {
        const card = createNodeCard(node);
        nodeLayer.appendChild(card);
        addDrag(card, node);
        addPortHandlers(card, node);
      });
    }

    function getPortPosition(el, side) {
      const rect = el.getBoundingClientRect();
      const parentRect = board.getBoundingClientRect();
      return {
        x: (rect.left - parentRect.left) / zoom + (side === "out" ? rect.width / zoom : 0),
        y: (rect.top - parentRect.top) / zoom + rect.height / (2 * zoom)
      };
    }

    function drawConnections() {
      connectionsSvg.innerHTML = "";
      const labelLayer = document.createElement("div");
      labelLayer.style.position = "absolute";
      labelLayer.style.inset = "0";
      labelLayer.style.pointerEvents = "none";
      labelLayer.id = "labels";
      boardViewport.querySelectorAll("#labels").forEach(el => el.remove());
      boardViewport.appendChild(labelLayer);

      state.links.forEach(link => {
        const fromEl = nodeLayer.querySelector(`[data-id="${link.from}"]`);
        const toEl = nodeLayer.querySelector(`[data-id="${link.to}"]`);
        if (!fromEl || !toEl) return;

        const start = getPortPosition(fromEl, "out");
        const end = getPortPosition(toEl, "in");
        const dx = Math.max(80, Math.abs(end.x - start.x) * 0.45);

        const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
        path.dataset.from = link.from;
        path.dataset.to = link.to;
        path.setAttribute("d", `M ${start.x} ${start.y} C ${start.x + dx} ${start.y}, ${end.x - dx} ${end.y}, ${end.x} ${end.y}`);
        path.setAttribute("fill", "none");
        path.setAttribute("stroke", "#c3cedf");
        path.setAttribute("stroke-width", "2");
        path.setAttribute("stroke-linecap", "round");
        path.style.pointerEvents = "stroke";
        path.style.cursor = "pointer";
        connectionsSvg.appendChild(path);

        if (link.label) {
          const midX = (start.x + end.x) / 2;
          const midY = (start.y + end.y) / 2 - 10;
          const label = document.createElement("div");
          label.className = "connector-label";
          label.textContent = link.label;
          label.style.left = midX + "px";
          label.style.top = midY + "px";
          labelLayer.appendChild(label);
        }
      });
    }

    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) return JSON.parse(saved);
      } catch (e) {
        console.warn("state load failed", e);
      }
      if (typeof structuredClone === "function") return structuredClone(defaultState);
      return JSON.parse(JSON.stringify(defaultState));
    }

    function persistState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.warn("state save failed", e);
      }
    }

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    function addDrag(card, node) {
      let dragging = false;
      let start = { x: 0, y: 0 };
      let offset = { x: 0, y: 0 };

      card.addEventListener("mousedown", (e) => {
        if (e.target.classList.contains("port")) return;
        dragging = true;
        const rect = card.getBoundingClientRect();
        const boardRect = board.getBoundingClientRect();
        start = { x: e.clientX, y: e.clientY };
        offset = { x: rect.left - boardRect.left, y: rect.top - boardRect.top };
        document.body.style.userSelect = "none";
      });

      window.addEventListener("mousemove", (e) => {
        if (!dragging) return;
        const boardRect = board.getBoundingClientRect();
        const dx = (e.clientX - start.x) / zoom;
        const dy = (e.clientY - start.y) / zoom;
        const nextX = clamp(offset.x + dx, 0, boardRect.width / zoom - card.offsetWidth);
        const nextY = clamp(offset.y + dy, 0, boardRect.height / zoom - card.offsetHeight);
        node.x = nextX;
        node.y = nextY;
        card.style.left = `${node.x}px`;
        card.style.top = `${node.y}px`;
        drawConnections();
      });

      window.addEventListener("mouseup", () => {
        if (!dragging) return;
        dragging = false;
        document.body.style.userSelect = "";
        persistState();
      });
    }

    function startConnection(fromId, startPoint) {
      activeConnection = { from: fromId, start: startPoint, path: null };
      board.classList.add("connecting");
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", "#7fc4ff");
      path.setAttribute("stroke-width", "2");
      path.setAttribute("stroke-dasharray", "6 4");
      path.setAttribute("stroke-linecap", "round");
      connectionsSvg.appendChild(path);
      activeConnection.path = path;
    }

    function updateConnectionPreview(clientX, clientY) {
      if (!activeConnection) return;
      const boardRect = board.getBoundingClientRect();
      const start = activeConnection.start;
      const end = { x: (clientX - boardRect.left) / zoom, y: (clientY - boardRect.top) / zoom };
      const dx = Math.max(60, Math.abs(end.x - start.x) * 0.4);
      activeConnection.path.setAttribute("d", `M ${start.x} ${start.y} C ${start.x + dx} ${start.y}, ${end.x - dx} ${end.y}, ${end.x} ${end.y}`);
    }

    function finishConnection(toId) {
      if (!activeConnection) return;
      const { from, path } = activeConnection;
      if (path) path.remove();
      if (toId && toId !== from) {
        const exists = state.links.some(l => l.from === from && l.to === toId);
        if (!exists) {
          state.links.push({ from, to: toId });
          persistState();
        }
      }
      activeConnection = null;
      board.classList.remove("connecting");
      nodeLayer.querySelectorAll(".port.target").forEach(p => p.classList.remove("target"));
      drawConnections();
    }

    function addPortHandlers(card, node) {
      const outPort = card.querySelector(".port.out");
      const inPort = card.querySelector(".port.in");

      outPort.addEventListener("mousedown", (e) => {
        e.stopPropagation();
        const start = getPortPosition(card, "out");
        startConnection(node.id, start);
      });

      inPort.addEventListener("mouseup", (e) => {
        e.stopPropagation();
        if (!activeConnection) return;
        finishConnection(node.id);
      });

      inPort.addEventListener("mouseenter", () => {
        if (activeConnection) inPort.classList.add("target");
      });
      inPort.addEventListener("mouseleave", () => {
        inPort.classList.remove("target");
      });
    }

    function setZoom(next) {
      const clamped = clamp(next, 0.6, 1.8);
      zoom = clamped;
      state.zoom = zoom;
      applyZoom();
      persistState();
    }

    function applyZoom() {
      boardViewport.style.transform = `scale(${zoom})`;
      zoomValue.textContent = `${Math.round(zoom * 100)}%`;
      drawConnections();
    }

    function init() {
      renderNodes();
      drawConnections();
      applyZoom();
      window.addEventListener("mousemove", (e) => updateConnectionPreview(e.clientX, e.clientY));
      window.addEventListener("mouseup", () => finishConnection());
      connectionsSvg.addEventListener("dblclick", (e) => {
        const target = e.target;
        if (target.tagName === "path" && target.dataset.from && target.dataset.to) {
          state.links = state.links.filter(l => !(l.from === target.dataset.from && l.to === target.dataset.to));
          persistState();
          drawConnections();
        }
      });
      window.addEventListener("resize", () => {
        drawConnections();
      });

      zoomOutBtn.addEventListener("click", () => setZoom(zoom - 0.1));
      zoomInBtn.addEventListener("click", () => setZoom(zoom + 0.1));
      board.addEventListener("wheel", (e) => {
        if (e.ctrlKey || e.metaKey) {
          e.preventDefault();
          const direction = e.deltaY > 0 ? -0.1 : 0.1;
          setZoom(zoom + direction);
        }
      }, { passive: false });
    }

    init();
  </script>
</body>
</html>
